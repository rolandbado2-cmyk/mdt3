<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORFK - MDT Rendszer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; min-height: 100vh; }
        .police-card { background: linear-gradient(145deg, #1e293b, #0f172a); border: 1px solid rgba(255, 255, 255, 0.05); }
        .nav-btn.active { background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b; color: #f59e0b; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .is-locked .auth-only { filter: blur(10px); pointer-events: none; opacity: 0.5; }
    </style>
</head>
<body class="is-locked">

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 bg-black/90 z-[200] flex items-center justify-center p-6 backdrop-blur-md">
        <div class="police-card w-full max-w-md rounded-3xl p-10 border-t-8 border-t-amber-500">
            <h2 class="text-2xl font-black uppercase text-center mb-6 italic">MDT Belépés</h2>
            <div class="space-y-4">
                <input type="text" id="l-name" placeholder="NÉV (Pl: ORFK ROLAND)" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-center font-bold uppercase outline-none focus:border-amber-500 text-white transition-all">
                <input type="password" id="l-pin" placeholder="PIN KÓD" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-center text-lg outline-none focus:border-amber-500 font-black text-white transition-all">
                <button onclick="login()" class="w-full bg-amber-500 text-black font-black py-4 rounded-xl uppercase hover:bg-amber-400 shadow-lg shadow-amber-500/10 transition-all">Csatlakozás a Rendszerhez</button>
            </div>
            <p class="text-[10px] text-slate-500 mt-4 text-center uppercase font-bold">Kapcsolódás: Neon Felhő Adatbázis</p>
        </div>
    </div>

    <!-- HEADER -->
    <header class="fixed top-0 w-full bg-slate-950/80 backdrop-blur-xl border-b border-white/5 z-[100] px-6 py-3 flex justify-between items-center">
        <div class="bg-amber-500 text-black px-3 py-1 rounded font-black text-sm italic tracking-tighter">ORFK MDT v4.0</div>
        <div class="flex items-center gap-4">
            <span id="auth-name" class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Nincs hitelesítve</span>
            <button id="logout-btn" onclick="logout()" class="hidden text-red-500 hover:text-red-400 text-[10px] font-black uppercase tracking-widest">Kilépés</button>
        </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="fixed left-0 top-0 h-full w-64 bg-slate-950 border-r border-white/5 pt-20 z-[90]">
        <div class="space-y-1 px-4">
            <button onclick="showTab('home')" class="nav-btn active w-full flex items-center gap-4 px-4 py-3 text-[10px] font-black uppercase tracking-widest"><i class="fas fa-home w-5"></i> Főoldal</button>
            <button onclick="showTab('mdt')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 text-[10px] font-black uppercase tracking-widest"><i class="fas fa-id-card w-5"></i> Adatbázis</button>
            <button onclick="showTab('wanted')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 text-[10px] font-black uppercase tracking-widest"><i class="fas fa-search w-5"></i> Körözések</button>
            <button onclick="showTab('archive')" class="nav-btn w-full flex items-center gap-4 px-4 py-3 text-[10px] font-black uppercase tracking-widest"><i class="fas fa-archive w-5"></i> Akták</button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="ml-64 pt-24 p-8">
        <div id="home" class="tab-content active">
            <div class="police-card rounded-3xl p-12 relative overflow-hidden">
                <div class="relative z-10">
                    <h1 class="text-6xl font-black italic uppercase leading-none mb-4 text-white">ORFK <br><span class="text-amber-500 text-4xl">MDT Rendszer</span></h1>
                    <p class="text-slate-400 max-w-lg italic text-sm">Üdvözöljük a központi lekérdező felületen. Minden művelet naplózásra kerül.</p>
                </div>
                <i class="fas fa-shield-halved absolute -right-10 -bottom-10 text-[200px] text-white/5 rotate-12"></i>
            </div>
        </div>

        <div id="mdt" class="tab-content auth-only">
            <div class="max-w-4xl mx-auto">
                <div class="flex gap-4 mb-8">
                    <input type="text" id="mdtInput" placeholder="Személy neve..." class="flex-grow bg-slate-900 border border-white/10 rounded-2xl px-6 py-4 font-bold uppercase outline-none focus:border-amber-500 text-white">
                    <button onclick="searchPerson()" class="bg-amber-500 text-black px-12 rounded-2xl font-black uppercase text-xs">Lekérés</button>
                </div>
                <div id="mdt-result"></div>
            </div>
        </div>

        <div id="wanted" class="tab-content auth-only">
             <div class="grid grid-cols-3 gap-8">
                <div class="police-card p-8 rounded-3xl h-fit">
                    <h3 class="text-lg font-black uppercase text-red-500 mb-6 italic">Körözés Kiadása</h3>
                    <div class="space-y-4">
                        <input type="text" id="w-name" placeholder="NÉV" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-xs font-bold uppercase text-white outline-none focus:border-red-500">
                        <textarea id="w-reason" placeholder="KÖRELMÉLET / INDOKLÁS" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-xs font-bold h-32 text-white outline-none focus:border-red-500"></textarea>
                        <button onclick="addWanted()" class="w-full bg-red-600 hover:bg-red-500 text-white font-black py-4 rounded-xl uppercase text-xs transition-all">Rögzítés</button>
                    </div>
                </div>
                <div class="col-span-2 police-card rounded-3xl overflow-hidden">
                    <div id="wanted-list" class="divide-y divide-white/5"></div>
                </div>
            </div>
        </div>

        <div id="archive" class="tab-content auth-only">
            <div class="police-card p-8 rounded-3xl mb-8">
                <h3 class="text-lg font-black uppercase text-blue-400 mb-6 italic">Akta Létrehozása</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <input type="text" id="a-name" placeholder="SZEMÉLY NEVE" class="bg-slate-900 border border-white/10 rounded-xl p-4 text-xs font-bold uppercase text-white">
                    <input type="text" id="a-charge" placeholder="BŰNCSELEKMÉNY" class="bg-slate-900 border border-white/10 rounded-xl p-4 text-xs font-bold uppercase text-white">
                    <input type="number" id="a-fine" placeholder="BÍRSÁG ($)" class="bg-slate-900 border border-white/10 rounded-xl p-4 text-xs font-bold text-white">
                    <input type="number" id="a-time" placeholder="BÖRTÖN (HÓ)" class="bg-slate-900 border border-white/10 rounded-xl p-4 text-xs font-bold text-white">
                </div>
                <button onclick="addArchive()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl uppercase text-xs tracking-widest transition-all">Adatbázisba Küldés</button>
            </div>
            <div id="archive-list" class="police-card rounded-3xl overflow-hidden"></div>
        </div>
    </main>

    <script>
        const API_URL = '/api/db';
        let currentUser = null;

        async function apiRequest(action, data = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Szerver hiba:", errorText);
                    return { error: true, message: "Szerver hiba történt." };
                }
                
                return await response.json();
            } catch (err) {
                console.error("Hálózati hiba:", err);
                return { error: true, message: "Nem érhető el az API." };
            }
        }

        async function login() {
            const nameInput = document.getElementById('l-name');
            const pinInput = document.getElementById('l-pin');
            const name = nameInput.value.trim().toUpperCase();
            const pin = pinInput.value.trim();

            if(!name || !pin) return;

            const res = await apiRequest('login', { name, pin });

            if (res.success) {
                currentUser = res.user;
                document.body.classList.remove('is-locked');
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('auth-name').innerText = currentUser.name;
                document.getElementById('logout-btn').classList.remove('hidden');
                refreshAll();
            } else {
                if(res.error) {
                    alert("HIBA: Az adatbázis nem elérhető! Ellenőrizd a Vercel beállításokat.");
                } else {
                    alert("HIBA: Érvénytelen név vagy PIN kód!");
                }
            }
        }

        function logout() {
            location.reload();
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(event) event.currentTarget.classList.add('active');
        }

        async function refreshAll() {
            loadWanted();
            loadArchive();
        }

        async function loadWanted() {
            const res = await apiRequest('getWanted');
            if (res.error) return;
            const list = document.getElementById('wanted-list');
            list.innerHTML = res.data.map(w => `
                <div class="p-6 flex justify-between items-center group hover:bg-white/5 transition-all">
                    <div>
                        <div class="text-red-500 font-black uppercase text-lg">${w.name}</div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase tracking-wider">${w.reason}</div>
                    </div>
                    <button onclick="deleteWanted(${w.id})" class="text-slate-600 hover:text-green-500 text-xl transition-colors"><i class="fas fa-check-circle"></i></button>
                </div>
            `).join('') || '<div class="p-10 text-center opacity-20 italic">Nincs aktív körözés a rendszerben</div>';
        }

        async function addWanted() {
            const name = document.getElementById('w-name').value.toUpperCase();
            const reason = document.getElementById('w-reason').value;
            if(!name || !reason) return;
            await apiRequest('addWanted', { name, reason });
            document.getElementById('w-name').value = '';
            document.getElementById('w-reason').value = '';
            loadWanted();
        }

        async function deleteWanted(id) {
            if(!confirm("Biztosan törölni szeretnéd a körözést? (Személy elfogva)")) return;
            await apiRequest('deleteWanted', { id });
            loadWanted();
        }

        async function loadArchive() {
            const res = await apiRequest('getArchive');
            if (res.error) return;
            const list = document.getElementById('archive-list');
            list.innerHTML = `
                <table class="w-full text-left text-[10px]">
                    <tr class="opacity-40 border-b border-white/5 uppercase font-black tracking-widest">
                        <th class="p-4 text-amber-500">Személy</th><th class="p-4">Vád</th><th class="p-4">Bírság</th><th class="p-4">Intézkedő</th>
                    </tr>
                    ${res.data.map(a => `
                        <tr class="border-b border-white/5 hover:bg-white/5 transition-all">
                            <td class="p-4 font-black uppercase text-white">${a.name}</td>
                            <td class="p-4 text-slate-300 font-bold uppercase">${a.charge}</td>
                            <td class="p-4 text-amber-500 font-black tracking-tighter">$ ${a.fine.toLocaleString()}</td>
                            <td class="p-4 opacity-50 italic uppercase">${a.officer}</td>
                        </tr>
                    `).join('')}
                </table>`;
        }

        async function addArchive() {
            const data = {
                name: document.getElementById('a-name').value.toUpperCase(),
                charge: document.getElementById('a-charge').value.toUpperCase(),
                fine: parseInt(document.getElementById('a-fine').value) || 0,
                jail_time: parseInt(document.getElementById('a-time').value) || 0,
                officer: currentUser.name
            };
            if(!data.name || !data.charge) return;
            await apiRequest('addArchive', data);
            document.getElementById('a-name').value = '';
            document.getElementById('a-charge').value = '';
            document.getElementById('a-fine').value = '';
            document.getElementById('a-time').value = '';
            refreshAll();
        }

        async function searchPerson() {
            const name = document.getElementById('mdtInput').value.toUpperCase();
            if(!name) return;
            const res = await apiRequest('searchPerson', { name });
            const resultDiv = document.getElementById('mdt-result');
            
            if(res.found) {
                resultDiv.innerHTML = `
                    <div class="police-card p-10 rounded-3xl border-l-4 ${res.wanted ? 'border-l-red-600' : 'border-l-green-500'}">
                        <div class="flex justify-between items-start mb-8">
                            <div>
                                <h2 class="text-4xl font-black uppercase text-white leading-none">${name}</h2>
                                <p class="text-[10px] font-black uppercase text-slate-500 mt-2 tracking-[0.2em]">Személyi Adatlap</p>
                            </div>
                            ${res.wanted ? '<span class="bg-red-600 px-6 py-2 rounded-lg font-black animate-pulse uppercase text-xs">KÖRÖZÖTT SZEMÉLY</span>' : '<span class="text-green-500 font-black uppercase tracking-widest text-xs"><i class="fas fa-check"></i> Tiszta</span>'}
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Bűnügyi Előélet</h4>
                            <div class="grid gap-2">
                                ${res.records.map(r => `
                                    <div class="bg-white/5 p-4 rounded-xl flex justify-between text-xs border border-white/5 hover:border-white/10 transition-all">
                                        <span class="font-bold text-slate-200 uppercase">${r.charge}</span>
                                        <span class="text-amber-500 font-black">$ ${r.fine.toLocaleString()}</span>
                                    </div>
                                `).join('') || '<p class="opacity-20 italic text-sm py-4">A személynek nincsenek rögzített bűncselekményei.</p>'}
                            </div>
                        </div>
                    </div>`;
            }
        }
    </script>
</body>
</html>
